<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veo å‰ç«¯æ¥µç°¡æ¸¬è©¦</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', Arial, sans-serif; margin: 24px; }
    button { padding: 10px 16px; font-size: 16px; }
    textarea, input { width: 100%; max-width: 800px; }
    .row { margin: 12px 0; }

    /* Tab æ¨£å¼ */
    .tab-container { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .tab-buttons { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
    .tab-btn { flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    .tab-btn.active { background: #fff; border-bottom: 2px solid #007bff; font-weight: bold; }
    .tab-btn:hover { background: #e9ecef; }
    .tab-content { padding: 20px; background: #fff; }

    /* éš±è—çš„ tab å…§å®¹ */
    .tab-content.hidden { display: none; }

    /* åœ–ç‰‡ä¸Šå‚³å€åŸŸ */
    .image-upload-area { border: 2px dashed #007bff; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: border-color 0.3s; }
    .image-upload-area:hover { border-color: #0056b3; }
    .image-upload-area.dragover { border-color: #28a745; background: #f8fff8; }
    .image-preview { max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 10px; display: none; }
    .image-info { margin-top: 10px; font-size: 14px; color: #666; }

    video { width: 100%; max-width: 720px; margin-top: 16px; }
    pre { background: #f4f4f4; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Veo å‰ç«¯æ¥µç°¡æ¸¬è©¦</h1>

  <!-- Tab å®¹å™¨ -->
  <div class="tab-container">
    <!-- Tab æŒ‰éˆ• -->
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="text">ğŸ“ æ–‡å­—ç”Ÿæˆ</button>
      <button class="tab-btn" data-tab="image">ğŸ–¼ï¸ åœ–ç‰‡+æ–‡å­—</button>
    </div>

    <!-- Tab 1: æ–‡å­—ç”Ÿæˆ -->
    <div id="text-tab" class="tab-content">
      <div class="row">
        <label>æç¤ºè©ï¼ˆpromptï¼‰</label>
        <textarea id="text-prompt" rows="4">A serene sunset over mountains in watercolor</textarea>
      </div>
      <div class="row">
        <label>è§£æåº¦</label>
        <select id="text-resolution">
          <option value="720p" selected>720p</option>
          <option value="480p">480p</option>
          <option value="1080p">1080p</option>
        </select>
      </div>
    </div>

    <!-- Tab 2: åœ–ç‰‡+æ–‡å­— -->
    <div id="image-tab" class="tab-content hidden">
      <div class="row">
        <label>ä¸Šå‚³åœ–ç‰‡</label>
        <div class="image-upload-area" id="image-upload-area">
          <div>ğŸ“¸ é»æ“Šæˆ–æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•</div>
          <div style="font-size: 12px; color: #666; margin-top: 8px;">æ”¯æ´ JPGã€PNG æ ¼å¼</div>
          <input type="file" id="image-input" accept="image/jpeg,image/png" style="display: none;">
        </div>
        <img id="image-preview" class="image-preview" alt="é è¦½åœ–ç‰‡">
        <div id="image-info" class="image-info"></div>
      </div>
      <div class="row">
        <label>æç¤ºè©ï¼ˆpromptï¼‰- å¯é¸ï¼Œç”¨æ–¼æè¿°æƒ³è¦çš„å‹•ç•«æ•ˆæœ</label>
        <textarea id="image-prompt" rows="3" placeholder="ä¾‹å¦‚ï¼šè®“åœ–ç‰‡ä¸­çš„å ´æ™¯å‹•èµ·ä¾†ï¼Œå¤ªé™½ç·©ç·©ç§»å‹•ï¼Œé›²æœµé£„ç§»"></textarea>
      </div>
      <div class="row">
        <label>è§£æåº¦</label>
        <select id="image-resolution">
          <option value="720p" selected>720p</option>
          <option value="480p">480p</option>
          <option value="1080p">1080p</option>
        </select>
      </div>
    </div>
  </div>

  <!-- å…±ç”¨æ§åˆ¶å€åŸŸ -->
  <div class="row">
    <button id="go">ä¸€éµç”Ÿæˆï¼ˆå¾Œç«¯ç­‰å¾…å®Œæˆï¼‰</button>
    <button id="download" style="display:none;">ä¸‹è¼‰å½±ç‰‡</button>
  </div>
  <div class="row">
    <div id="progress" style="display:none;">
      <p>ğŸ¬ æ­£åœ¨ç”Ÿæˆå½±ç‰‡... <span id="elapsed">0</span> ç§’</p>
      <div style="width:100%; height:20px; background:#f0f0f0; border-radius:10px;">
        <div id="progressBar" style="width:0%; height:100%; background:#4CAF50; border-radius:10px; transition:width 0.5s;"></div>
      </div>
    </div>
  </div>
  <div class="row">
    <pre id="log"></pre>
  </div>
  <video id="video" controls style="display:none;"></video>

  <script>
    // å…¨åŸŸè®Šæ•¸
    let currentTab = 'text';
    let selectedImageFile = null;
    let selectedImageBase64 = null;

    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
    };

    // Tab åˆ‡æ›åŠŸèƒ½
    function switchTab(tabName) {
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // æ›´æ–°å…§å®¹é¡¯ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${tabName}-tab`).classList.remove('hidden');

      currentTab = tabName;
      log(`ğŸ”„ åˆ‡æ›åˆ° ${tabName === 'text' ? 'æ–‡å­—ç”Ÿæˆ' : 'åœ–ç‰‡+æ–‡å­—'} æ¨¡å¼`);
    }

    // åˆå§‹åŒ– Tab äº‹ä»¶ç›£è½å™¨
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
    const imageUploadArea = document.getElementById('image-upload-area');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const imageInfo = document.getElementById('image-info');

    // é»æ“Šä¸Šå‚³å€åŸŸ
    imageUploadArea.addEventListener('click', () => {
      imageInput.click();
    });

    // æª”æ¡ˆé¸æ“‡
    imageInput.addEventListener('change', handleImageSelect);

    // æ‹–æ‹½åŠŸèƒ½
    imageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      imageUploadArea.classList.add('dragover');
    });

    imageUploadArea.addEventListener('dragleave', () => {
      imageUploadArea.classList.remove('dragover');
    });

    imageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      imageUploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleImageFile(files[0]);
      }
    });

    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handleImageFile(file);
      }
    }

    function handleImageFile(file) {
      // æª¢æŸ¥æª”æ¡ˆé¡å‹
      if (!file.type.match('image/(jpeg|png)')) {
        log('âŒ è«‹é¸æ“‡ JPG æˆ– PNG æ ¼å¼çš„åœ–ç‰‡');
        return;
      }

      // æª¢æŸ¥æª”æ¡ˆå¤§å° (é™åˆ¶ 10MB)
      if (file.size > 10 * 1024 * 1024) {
        log('âŒ åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MB');
        return;
      }

      selectedImageFile = file;

      // é¡¯ç¤ºé è¦½
      const reader = new FileReader();
      reader.onload = (e) => {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
        selectedImageBase64 = e.target.result.split(',')[1]; // ç§»é™¤ data:image/...;base64,å‰ç¶´
        imageInfo.textContent = `ğŸ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        log(`âœ… åœ–ç‰‡å·²é¸æ“‡: ${file.name}`);
      };
      reader.readAsDataURL(file);
    }

    // ç”ŸæˆæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    document.getElementById('go').addEventListener('click', async () => {
      let prompt, resolution, endpoint, requestData;

      if (currentTab === 'text') {
        // æ–‡å­—ç”Ÿæˆæ¨¡å¼
        prompt = document.getElementById('text-prompt').value;
        resolution = document.getElementById('text-resolution').value;
        endpoint = 'http://localhost:8001/api/veo/generate/wait';
        requestData = {
          prompt,
          resolution,
          durationSeconds: 6,
          aspectRatio: "16:9",
          sampleCount: 1,
          generateAudio: true
        };
      } else {
        // åœ–ç‰‡+æ–‡å­—æ¨¡å¼
        if (!selectedImageBase64) {
          log('âŒ è«‹å…ˆé¸æ“‡ä¸€å¼µåœ–ç‰‡');
          return;
        }

        prompt = document.getElementById('image-prompt').value || 'è®“åœ–ç‰‡ä¸­çš„å ´æ™¯å‹•ç•«åŒ–ï¼ŒåŠ å…¥è‡ªç„¶çš„å‹•æ…‹æ•ˆæœ';
        resolution = document.getElementById('image-resolution').value;
        endpoint = 'http://localhost:8001/api/veo/generate/image-text/wait';
        requestData = {
          prompt,
          imageBase64: selectedImageBase64,
          imageMimeType: selectedImageFile.type,
          resolution,
          durationSeconds: 8,
          aspectRatio: "16:9",
          sampleCount: 1,
          generateAudio: true
        };
      }

      log(`ğŸš€ é–‹å§‹ç”Ÿæˆå½±ç‰‡ (${currentTab === 'text' ? 'æ–‡å­—æ¨¡å¼' : 'åœ–ç‰‡+æ–‡å­—æ¨¡å¼'})...`);

      // é¡¯ç¤ºé€²åº¦æ¢
      const progressDiv = document.getElementById('progress');
      const progressBar = document.getElementById('progressBar');
      const elapsedSpan = document.getElementById('elapsed');
      progressDiv.style.display = 'block';

      // ç¦ç”¨ç”ŸæˆæŒ‰éˆ•
      const goBtn = document.getElementById('go');
      goBtn.disabled = true;
      goBtn.textContent = 'ç”Ÿæˆä¸­...';

      let startTime = Date.now();
      const progressInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        elapsedSpan.textContent = elapsed;
        // æ¨¡æ“¬é€²åº¦ï¼ˆå¯¦éš›é€²åº¦ç”±å¾Œç«¯æ§åˆ¶ï¼‰
        const simulatedProgress = Math.min(elapsed * 2, 90); // æ¯ç§’ç´„2%
        progressBar.style.width = simulatedProgress + '%';
      }, 1000);

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });
        const data = await res.json();
        log('ğŸ“¡ æ”¶åˆ°å›æ‡‰: ' + JSON.stringify(data, null, 2));

        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        if (!data.ok) {
          log('âŒ ç”Ÿæˆå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
          return;
        }

        if (!data.done) {
          log('â° å¾Œç«¯ç­‰å¾…å·²é”ä¸Šé™ (5åˆ†é˜)ï¼Œè«‹ç¨å¾Œç”¨ operationName ç¹¼çºŒæŸ¥è©¢');
          log('ğŸ”„ Operation ID: ' + data.operationName);
          return;
        }

        // å¾å›å‚³ä¸­æ‰¾ base64 å½±ç‰‡ - æ”¯æŒå¤šç¨®çµæ§‹
        let b64 = '';
        let mimeType = 'video/mp4';

        // æª¢æŸ¥ videos çµæ§‹ (å¯¦éš›çš„ API éŸ¿æ‡‰çµæ§‹)
        const videos = (data.response && data.response.videos) || [];
        if (videos.length > 0) {
          const video = videos[0];
          b64 = video.bytesBase64Encoded || '';
          mimeType = video.mimeType || 'video/mp4';
          log('ğŸ“Š æ‰¾åˆ°å½±ç‰‡è³‡æ–™ (videos çµæ§‹)');
        }

        // å¦‚æœæ²’æ‰¾åˆ°ï¼Œæª¢æŸ¥ predictions çµæ§‹ (å‚™ç”¨)
        if (!b64) {
          const preds = (data.response && data.response.predictions) || [];
          if (preds.length > 0) {
            const pred = preds[0];
            b64 = pred.video || pred.content || '';
            log('ğŸ“Š æ‰¾åˆ°å½±ç‰‡è³‡æ–™ (predictions çµæ§‹)');
          }
        }

        if (!b64) {
          log('âŒ æ‰¾ä¸åˆ° Base64 å½±ç‰‡å…§å®¹');
          log('ğŸ” å®Œæ•´éŸ¿æ‡‰çµæ§‹: ' + JSON.stringify(data.response, null, 2));
          return;
        }

        log('âœ… å½±ç‰‡ç”ŸæˆæˆåŠŸï¼');
        log('ğŸ“Š å½±ç‰‡å¤§å°: ' + Math.round(b64.length * 3/4 / 1024) + ' KB');

        // é¡¯ç¤ºå½±ç‰‡
        const blob = b64ToBlob(b64, mimeType);
        const url = URL.createObjectURL(blob);
        const video = document.getElementById('video');
        video.src = url;
        video.style.display = 'block';

        // é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
        const downloadBtn = document.getElementById('download');
        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = url;
          a.download = `veo_${currentTab}_${Date.now()}.mp4`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          log('ğŸ’¾ å½±ç‰‡å·²ä¸‹è¼‰ï¼');
        };

        // è‡ªå‹•æ’­æ”¾
        video.play();

      } catch (e) {
        clearInterval(progressInterval);
        log('âŒ ç¶²è·¯éŒ¯èª¤: ' + (e.message || String(e)));
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        goBtn.disabled = false;
        goBtn.textContent = 'ä¸€éµç”Ÿæˆï¼ˆå¾Œç«¯ç­‰å¾…å®Œæˆï¼‰';
      }
    });

    function b64ToBlob(b64Data, contentType='', sliceSize=512) {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];
      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
      return new Blob(byteArrays, {type: contentType});
    }
  </script>
</body>
</html>
